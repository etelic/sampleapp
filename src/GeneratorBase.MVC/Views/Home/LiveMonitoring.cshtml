@{
    ViewBag.Title = "Real-time Data Monitoring";
}
<div class="row">
    <div class="col-lg-12">
        <h1 class="page-title">
            <i class="glyphicon glyphicon-exclamation-sign text-primary"></i> Real-Time Data Monitoring 
        </h1>
        <h2 class="text-primary small">Page will show alerts automatically,Click value to view full details. Refreshing or navigating to other page will lost all previously shown alerts.</h2>
    </div>
</div>
<div class="panel panel-default">
    <div class="panel-heading">
        <h4 class="panel-title" style="float:none;"><span class="glyphicon glyphicon-arrow-right"></span>
            <a data-toggle="collapse" data-parent="#accordion" href="#T_School">School Alerts</a>
        </h4>
    </div>
    <div class="panel-collapse collapse in" id="T_School">
        <div class="tabbable responsive">
            <div id="Des_Table" class="table-responsive" style="overflow-x:auto;">
                <table class="table table-striped table-bordered table-hover table-condensed">
                    <thead id="discussion">
                        <tr>
                            <th class="col1">User Name</th>
                            <th class="col1">School Value</th>
                            <th class="col1">Date Time</th>
                            <th class="col1">Action</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="@Url.Content("~/Scripts/jquery-1.10.2.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.signalR-2.1.2.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.signalR-2.1.2.min.js")"></script>
<script src="@Url.Content("~/signalr/hubs")"></script>
<script type="text/javascript">
    $(function () {
        var chat = $.connection.iServerHub;
        chat.client.broadcastMessage = function (obj) {
            var result = JSON.parse(obj);
            var entityid = result['entityid'];
            var name = result['username'];
            var message = result['entitydisplayname'];
            var datetime = result['datetime'];
            var action = result['action'];
            var entityname = result['entityname'];
            var href = '@Html.ActionLink("_dispName", "Details", "_entityname", new { id = "_id" }, new { target="_blank"})'.replace("_dispName", message).replace("_entityname", entityname).replace("_id", entityid);
            var icon = "<i class=\"glyphicon glyphicon-pencil\"></i> "
            if (action == 'Added')
                icon = "<i class=\"glyphicon glyphicon-plus-sign text-success\"></i> "
            var encodedName = $('<div />').text(name).html();
            var encodedMsg = $('<div />').text(message).html();
            $('#discussion', '#' + entityname).append(
                '<tr><td>' + encodedName + '</td>'
                + '<td>'+href+'</td>'
                + '<td>' + datetime + '</td>'
                  + '<td>'+icon + action + '</td>'
                  + '</tr>'
                );
        };
        $.connection.hub.start().done(function () {
        });
    });
</script>
